<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF to EPUB Converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at top, #1a1d2b, #0f1119);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: system-ui, sans-serif;
  color: #fff;
}

.card {
  width: 100%;
  max-width: 540px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(14px);
  border-radius: 20px;
  padding: 28px;
  box-shadow: 0 20px 50px rgba(0,0,0,.4);
}

h1 { text-align: center; margin-bottom: 6px; }
p { text-align: center; color: #aaa; }

input[type="file"] {
  width: 100%;
}

.file-list {
  margin-top: 12px;
  border-radius: 12px;
  overflow: hidden;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: rgba(255,255,255,0.06);
  margin-bottom: 6px;
  border-radius: 10px;
  font-size: 0.9rem;
}

.file-item span {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 380px;
}

.file-item button {
  background: transparent;
  border: none;
  color: #ff6b6b;
  font-size: 1.1rem;
  cursor: pointer;
}

button.main {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  background: #bafc04;
  font-weight: 600;
  cursor: pointer;
  margin-top: 14px;
}

.progress {
  display: none;
  margin-top: 20px;
}

.track {
  width: 100%;
  height: 14px;
  background: #333;
  border-radius: 999px;
  overflow: hidden;
}

.bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #bafc04, #7cff00);
  transition: width .4s ease;
}

footer {
  text-align: center;
  margin-top: 24px;
  color: #aaa;
  font-size: .85rem;
}
footer span { color: #bafc04; }
</style>
</head>

<body>
<div class="card">
  <h1>PDF → EPUB Converter</h1>
  <p>Batch convert multiple PDFs</p>

  <form id="batchForm" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" id="fileInput" accept=".pdf" multiple>
    <div id="fileList" class="file-list"></div>
    <button class="main" id="convertBtn">Convert</button>
  </form>

  <div class="progress" id="progressBox">
    <div class="track"><div class="bar" id="bar"></div></div>
    <p id="status">Starting…</p>
    <button class="main" id="downloadBtn" style="display:none;">Download All</button>
  </div>

  <footer>Made by <span>Lightning Lab’s</span></footer>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const fileListEl = document.getElementById("fileList");
const form = document.getElementById("batchForm");
const bar = document.getElementById("bar");
const statusText = document.getElementById("status");
const progressBox = document.getElementById("progressBox");
const downloadBtn = document.getElementById("downloadBtn");
const convertBtn = document.getElementById("convertBtn");

let selectedFiles = [];
let poller = null;
let downloadUrls = [];

/* =========================
   FILE SELECTION + DELETE
========================= */
fileInput.addEventListener("change", () => {
  selectedFiles = [...selectedFiles, ...Array.from(fileInput.files)];
  fileInput.value = "";
  renderFileList();
});

function renderFileList() {
  fileListEl.innerHTML = "";
  selectedFiles.forEach((file, index) => {
    const div = document.createElement("div");
    div.className = "file-item";

    const name = document.createElement("span");
    name.textContent = file.name;

    const btn = document.createElement("button");
    btn.innerHTML = "✕";
    btn.onclick = () => {
      selectedFiles.splice(index, 1);
      renderFileList();
    };

    div.appendChild(name);
    div.appendChild(btn);
    fileListEl.appendChild(div);
  });
}

/* =========================
   SUBMIT
========================= */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (selectedFiles.length === 0) {
    alert("Please select at least one PDF file.");
    return;
  }

  convertBtn.disabled = true;
  resetProgress();

  const fd = new FormData();
  selectedFiles.forEach(f => fd.append("files", f));
  fd.append("csrfmiddlewaretoken",
    document.querySelector('[name=csrfmiddlewaretoken]').value
  );

  const res = await fetch("{% url 'batch' %}", {
    method: "POST",
    credentials: "same-origin",
    body: fd
  });

  const data = await res.json();
  if (!data.task_id) {
    alert("Upload failed");
    convertBtn.disabled = false;
    return;
  }

  progressBox.style.display = "block";
  poll(data.task_id);
});

/* =========================
   PROGRESS POLLING
========================= */
function poll(taskId) {
  poller = setInterval(async () => {
    const r = await fetch(`/progress/${taskId}/`);
    const d = await r.json();

    const percent = Math.round((d.done / d.total) * 100);
    bar.style.width = percent + "%";
    statusText.innerText = `${d.done}/${d.total} converted`;

    if (d.status === "completed") {
      clearInterval(poller);
      downloadUrls = d.files;
      statusText.innerText = "Completed!";
      downloadBtn.style.display = "block";
    }
  }, 5000);
}

/* =========================
   DOWNLOAD + RESET
========================= */
downloadBtn.onclick = () => {
  downloadUrls.forEach(url => {
    const a = document.createElement("a");
    a.href = url;
    a.download = "";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  setTimeout(resetAll, 1500);
};

function resetProgress() {
  bar.style.width = "0%";
  statusText.innerText = "Starting…";
  downloadBtn.style.display = "none";
}

function resetAll() {
  selectedFiles = [];
  renderFileList();
  progressBox.style.display = "none";
  resetProgress();
  convertBtn.disabled = false;
}
</script>
</body>
</html>
