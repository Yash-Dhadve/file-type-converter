<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF → EPUB Converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#0f1119;
  color:#fff;
  font-family:system-ui;
}
.card{
  width:100%;
  max-width:540px;
  background:#1b1f2b;
  padding:28px;
  border-radius:18px;
}
h2{text-align:center;margin-bottom:12px}
.file{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:8px;
  padding:10px 12px;
  background:#2a2f3d;
  border-radius:10px;
}
.file span{cursor:pointer;color:#ff5c5c;font-size:18px}
button{
  width:100%;
  margin-top:14px;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#bafc04;
  font-weight:600;
  cursor:pointer;
}
button:disabled{opacity:.6;cursor:not-allowed}
.progress{display:none;margin-top:18px}
.track{
  width:100%;
  height:10px;
  background:#333;
  border-radius:999px;
  overflow:hidden;
}
.bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#bafc04,#7cff00);
  transition:width .4s ease;
}
footer{text-align:center;margin-top:18px;color:#aaa}
footer span{color:#bafc04}
</style>
</head>

<body>
<div class="card">
  <h2>PDF → EPUB Converter</h2>

  <form id="batchForm">
    {% csrf_token %}

    <label style="
      display:block;
      border:2px dashed #444;
      padding:14px;
      text-align:center;
      border-radius:14px;
      cursor:pointer;
      margin-bottom:8px;">
      Choose PDFs
      <input type="file" id="fileInput" accept=".pdf" multiple hidden>
    </label>

    <div id="fileList"></div>

    <button id="convertBtn" type="submit">Convert</button>
  </form>

  <div class="progress" id="progressBox">
    <div class="track">
      <div class="bar" id="progressBar"></div>
    </div>
    <p id="statusText">Starting…</p>
    <button id="downloadBtn" style="display:none">Download All</button>
  </div>

  <footer>Made by <span>Lightning Lab’s</span></footer>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const fileList = document.getElementById("fileList");
const form = document.getElementById("batchForm");
const convertBtn = document.getElementById("convertBtn");
const progressBox = document.getElementById("progressBox");
const progressBar = document.getElementById("progressBar");
const statusText = document.getElementById("statusText");
const downloadBtn = document.getElementById("downloadBtn");

let selectedFiles = [];
let downloadUrls = [];
let taskId = null;

/* ---------------- FILE PICKER ---------------- */
fileInput.addEventListener("change", () => {
  selectedFiles.push(...Array.from(fileInput.files));
  fileInput.value = "";
  renderFiles();
});

function renderFiles(){
  fileList.innerHTML = "";
  selectedFiles.forEach((file, index) => {
    const div = document.createElement("div");
    div.className = "file";
    div.innerHTML = `
      <span>${file.name}</span>
      <span>&times;</span>
    `;
    div.lastElementChild.onclick = () => {
      selectedFiles.splice(index, 1);
      renderFiles();
    };
    fileList.appendChild(div);
  });
}

/* ---------------- FORM SUBMIT (FIXED) ---------------- */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!selectedFiles.length) {
    alert("Please select at least one PDF file");
    return;
  }

  convertBtn.disabled = true;
  convertBtn.innerText = "Converting…";

  const formData = new FormData();
  selectedFiles.forEach(f => formData.append("files", f));
  formData.append(
    "csrfmiddlewaretoken",
    document.querySelector('[name=csrfmiddlewaretoken]').value
  );

  const res = await fetch("/", {
    method: "POST",
    credentials: "same-origin",
    body: formData
  });

  const data = await res.json();
  taskId = data.task_id;

  progressBox.style.display = "block";
  pollProgress();
});

/* ---------------- PROGRESS POLLING ---------------- */
function pollProgress(){
  const interval = setInterval(async () => {
    const r = await fetch(`/progress/${taskId}/`);
    const d = await r.json();

    const percent = Math.round((d.done / d.total) * 100);
    progressBar.style.width = percent + "%";
    statusText.innerText = `${d.done} / ${d.total} converted`;

    if (d.status === "completed") {
      clearInterval(interval);
      downloadUrls = d.files;
      statusText.innerText = "Conversion completed!";
      downloadBtn.style.display = "block";
    }
  }, 5000);
}

/* ---------------- DOWNLOAD + CLEANUP ---------------- */
downloadBtn.addEventListener("click", async () => {
  downloadUrls.forEach(url => window.open(url, "_blank"));

  await fetch(`/cleanup/${taskId}/`, {
    method: "POST",
    credentials: "same-origin",
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  });

  setTimeout(() => location.reload(), 1200);
});
</script>
</body>
</html>
